<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>BC Tchat</title>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="./style.css">
<link rel="stylesheet" href="assets/css/loader.css">

</head>
<body class="modal-active">

<div id="modal-container">
    <div class="modal-background">
        <form class="modal" method="post" id="formUsername">
            <h2>Choisis ton pseudo</h2>
            <input autofocus type="text" name="username" id="inputUsername">
            <div class="loader hidden" id="loaderUsername"></div>
        </form>
    </div>
</div>

<!-- partial:index.partial.html -->
<section class="msger" id="chatHeader">
  <header class="msger-header">
    <div class="msger-header-title">
      <i class="fas fa-comment-alt"></i> The Blender Clan Tchat | <b id="usersCount"></b>
    </div>
    <div class="msger-header-options">
      <span><i class="fas fa-cog"></i></span>
    </div>
  </header>

  <main class="msger-chat">
    <!--
    <div class="msg left-msg">
      <div
       class="msg-img"
       style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)"
      ></div>

      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">BOT</div>
          <div class="msg-info-time">12:45</div>
        </div>

        <div class="msg-text">
          Hi, welcome to SimpleChat! Go ahead and send me a message. ðŸ˜„
        </div>
      </div>
    </div>
    -->

    <!--
    <div class="msg right-msg">
      <div
       class="msg-img"
       style="background-image: url(https://image.flaticon.com/icons/svg/145/145867.svg)"
      ></div>

      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">Sajad</div>
          <div class="msg-info-time">12:46</div>
        </div>

        <div class="msg-text">
          You can change your name in JS section!
        </div>
      </div>
    </div>
    -->
  </main>

  <form class="msger-inputarea">
    <span class="someoneWriting hidden">Quelqu'un est en train d'Ã©crire</span>
    <input type="text" id="inputMessage" class="msger-input" autocomplete="off" placeholder="Ã‰crire un message...">
    <button type="submit" class="msger-send-btn">Envoyer</button>
  </form>
</section>



<!-- partial -->
  <script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script><script  src="./script.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket=io();

    let formUsername = document.body.querySelector("#formUsername")
    let inputUsername = formUsername.querySelector("#inputUsername")
    let loadertUsername = formUsername.querySelector("#loaderUsername")
    let messageRawInput = document.body.querySelector("#inputMessage")
    
    const messageInputForm = get(".msger-inputarea");
    const messageInputText = get(".msger-input");

    let username
    let allUsers

    //Formulaire de connexion
    formUsername.addEventListener('submit', (event) => {
      event.preventDefault()
      let usernameWanted = inputUsername.value
      socket.emit('setUsername', usernameWanted)
      inputUsername.classList.add("hidden")
      loadertUsername.classList.remove("hidden")
    })

    //Envoi d'un message
    messageInputForm.addEventListener("submit", event => {
      event.preventDefault()
      sendMessage()
    });


    //Detection Ã©criture
    let isWriting = false
    let stopWriting
    messageRawInput.addEventListener('keydown', (event) => {
      if(event.keyCode != 13)
      {
        clearTimeout(stopWriting)
        if(isWriting == false)
        {    
          isWriting = true
          socket.emit('startWriting')
        }

        stopWriting = setTimeout(() => {
          isWriting = false
          socket.emit('stopWriting')
        }, 1000);
      }
    })


    function sendMessage()
    {
      let text = messageInputText.value.trim()
      if(text != '')
      {
        socket.emit('sendMessage', text)
        messageInputText.value = ''

        //Traitement detection Ã©criture
          isWriting = false
          clearTimeout(stopWriting)
          socket.emit('stopWriting')
      }

    }

    //rÃ©ponse serveur
    socket.on('acceptUsername', (_username, _allUsers) => {
      username = _username
      allUsers = _allUsers
      closeModal()
      updateUsersCount(_allUsers)
    })

    socket.on("rejectUsername", (_username) => {
      inputUsername.value = ''
      inputUsername.setAttribute('placeholder', "Le pseudo "+_username+" est dÃ©jÃ  utilisÃ©")
      
      inputUsername.classList.remove("hidden")
      loadertUsername.classList.add("hidden")
    })

    //Connexion d'un nouvel utilisateur
    socket.on('newUser', (newUsername, _allUsers) => {
      allUsers = _allUsers
      updateUsersCount(_allUsers)
      messageNewUser(newUsername)
    })

    //DÃ©connexion d'un utilisateur
    socket.on('leftUser', (leftUser, _allUsers) => {
      allUsers = _allUsers
      updateUsersCount(_allUsers)
      messageLeftUser(leftUser)
    })

    //Affichage d'un message
    socket.on('confirmMessage', (text) => appendMessage(username, 'right', text))
    socket.on('newMessage', (text, usernameSender) => appendMessage(usernameSender, 'left', text))

    //Information Ã©criture
    socket.on('userStartWriting', (peopleWriting) => {
      showPeopleWriting(peopleWriting)
    })

    socket.on('userStopWriting', () => {
      removePeopleWriting()
    })

    //Fonctions info Ã©criture
    var someoneWriting = document.body.querySelector('.someoneWriting')
    function showPeopleWriting(peopleWriting)
    {
      peopleWriting = peopleWriting.map((writingName) => {
        if(writingName != username)
        {
          return writingName
        }
      })
      
      if(peopleWriting.length == 1)
      {
        someoneWriting.innerHTML = peopleWriting[0] + ' est en train d\'Ã©crire...'
      }
      else if(peopleWriting.length > 1)
      {
        someoneWriting.innerHTML = 'Plusieurs personnes sont en train d\'Ã©crire...'
      }

      someoneWriting.classList.remove('hidden')
    }

    function removePeopleWriting()
    {
      someoneWriting.classList.add('hidden')
    }

  </script>


</body>
</html>
